<%= render :partial => "/home/navbar" %>

<div class="content-section-a">
    <div class="container" style="margin-top: 40px">

        <div class="row">
            <div class="col s12 m12 l12 ">
                <div class="card">

                    <div class="card-image">
                        <nav>
                            <div class="nav-wrapper cyan darken-4">
                                <div class="col s12">
                                    <a class="breadcrumb">1단계</a>
                                </div>
                            </div>
                        </nav>

                        <div class="col s12 m12 l12">
                                <div class="card-content">
                                    <p class="card-title">
                                        <h4>위치등록</h4>
                                    </p>
                                    <div class="divider"></div>
                                    <p class="card-title">
                                        <h5>위치</h5>
                                    </p>
                                    <blockquote>
                                        기록하실 방의 위치를 지도에서 선택하세요.
                                    </blockquote>
                                    <div id="map" style="width: 100%; height: 400px;">
                                      <p id="centerAddr"></p>
                                    </div>
                                    <div class = "divider"></div>
                                </div>
                        </div>

                    </div>

                    <form action="/home/list_path_a" method="POST">
                      <div class=  "container">
                        <div class="form-group">
                          <label for="address">
                            <h6>주소</h6>
                          </label>
                          <input type="text" name="address" class="form-control" id="address" placeholder="지도에서 클릭해주세요." required readonly>
                          <label for="detail_address">
                            <h6>건물 이름</h6>
                          </label>
                          <input type="text" name="detail_address" class="form-control" id="detail_address" placeholder="세부 주소를 입력해주세요." autocomplete="off">
                          <input type="hidden" name="current_user" value="<%= current_user.email %>">
                          <textarea type="text" name="marker1" class="form-control" id="marker1" style="resize: none; display: none;" required readonly rows="1"></textarea>
                          <textarea type="text" name="marker2" class="form-control" id="marker2" style="resize: none; display: none;" required readonly rows="1"></textarea>
                        </div>
                      </div>

                        <div class="card-action">
                            <!--건물 이름-->
                            <div class="center-align">
                                <a href="/home/index" class="btn btn-default">취소하기</a>
                                <input class="btn btn-default" type="submit" value="다음단계">
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<%= render :partial => "/home/footer" %>

<!--지도 이벤트-->
<script>
    var mapContainer = document.getElementById('map'), // 지도를 표시할 div
        mapOption = {
            center: new daum.maps.LatLng(36.363626, 127.347757), // 지도의 중심좌표
            level: 2 // 지도의 확대 레벨
        };

    // 지도를 생성합니다
    var map = new daum.maps.Map(mapContainer, mapOption);

    var mapTypeControl = new daum.maps.MapTypeControl();

    // 지도에 컨트롤을 추가해야 지도위에 표시됩니다 daum.maps.ControlPosition은 컨트롤이 표시될 위치를 정의하는데 TOPRIGHT는 오른쪽 위를 의미합니다
    map.addControl(mapTypeControl, daum.maps.ControlPosition.TOPRIGHT);

    // 지도 확대 축소를 제어할 수 있는  줌 컨트롤을 생성합니다
    var zoomControl = new daum.maps.ZoomControl();
    map.addControl(zoomControl, daum.maps.ControlPosition.RIGHT);

    // 주소-좌표 변환 객체를 생성합니다
    var geocoder = new daum.maps.services.Geocoder();

    var marker = new daum.maps.Marker(), // 클릭한 위치를 표시할 마커입니다
        infowindow = new daum.maps.InfoWindow({zindex: 1}); // 클릭한 위치에 대한 주소를 표시할 인포윈도우입니다

    // 현재 지도 중심좌표로 주소를 검색해서 지도 좌측 상단에 표시합니다
    searchAddrFromCoords(map.getCenter(), displayCenterInfo);

    // 지도를 클릭했을 때 클릭 위치 좌표에 대한 주소정보를 표시하도록 이벤트를 등록합니다
    daum.maps.event.addListener(map, 'click', function (mouseEvent) {
        searchDetailAddrFromCoords(mouseEvent.latLng, function (status, result) {
            if (status === daum.maps.services.Status.OK) {
                var detailAddr = !!result[0].roadAddress.name
                    ? '<div>도로명주소 : ' + result[0].roadAddress.name + '</div>'
                    : '';
                detailAddr += '<div>지번 주소 : ' + result[0].jibunAddress.name + '</div>';

                if (result[0].roadAddress.name == "")
                    var address_of_building = result[0].jibunAddress.name;
                else
                    var address_of_building = result[0].jibunAddress.name + " (" + result[0].roadAddress.name + ")";

                var enc = address_of_building
                $('input[name=address]').attr('value', enc);

                var content = '<div class="bAddr">' + detailAddr + '</div>';

                // 마커를 클릭한 위치에 표시합니다
                marker.setPosition(mouseEvent.latLng);
                marker.setMap(map);

                // 인포윈도우에 클릭한 위치에 대한 법정동 상세 주소정보를 표시합니다
                infowindow.setContent(content);
                infowindow.open(map, marker);

                // 클릭한 위도, 경도 정보를 가져옵니다
                var latlng = mouseEvent.latLng;

                var marker1 = latlng.getLat();
                var marker2 = latlng.getLng();

                document.getElementById('marker1').innerHTML = marker1;
                document.getElementById('marker2').innerHTML = marker2;
            }
        });
    });

    // 중심 좌표나 확대 수준이 변경됐을 때 지도 중심 좌표에 대한 주소 정보를 표시하도록 이벤트를 등록합니다
    daum.maps.event.addListener(map, 'idle', function () {
        searchAddrFromCoords(map.getCenter(), displayCenterInfo);
    });

    function searchAddrFromCoords(coords, callback) {
        // 좌표로 행정동 주소 정보를 요청합니다
        geocoder.coord2addr(coords, callback);
    }

    function searchDetailAddrFromCoords(coords, callback) {
        // 좌표로 법정동 상세 주소 정보를 요청합니다
        geocoder.coord2detailaddr(coords, callback);
    }

    // 지도 좌측상단에 지도 중심좌표에 대한 주소정보를 표출하는 함수입니다
    function displayCenterInfo(status, result) {
        if (status === daum.maps.services.Status.OK) {
            var infoDiv = document.getElementById('centerAddr');
            $('#map').ready(function () {
                infoDiv.innerHTML = result[0].fullName;
            });
        }
    }
</script>

<!--detail_address textarea 엔터키 제한-->
<script>
    $('#detail_address').keydown(function () {
        var rows = $('#detail_address').val().split('\n').length;
        var maxRows = 1;
        if (rows > maxRows) {
            alert("한줄로 입력해주세요.");
            modifiedText = $('#detail_address').val().split("\n").slice(0, maxRows);
            $('#detail_address').val(modifiedText.join("\n"));
        }
    });
</script>

<!--취소하기 버튼-->
<script>
    function go_to_home() {
        history.back();
    }
</script>
